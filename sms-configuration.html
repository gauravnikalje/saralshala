<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMS Configuration - School Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script type="module" src="js/sms-service.js"></script>
    <style>
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .animated-gradient {
            background: linear-gradient(-45deg, #667eea, #764ba2, #f093fb, #f5576c);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in { animation: fadeIn 0.5s ease-out; }
    </style>
</head>
<body class="min-h-screen animated-gradient">
    <div x-data="smsConfigApp()" x-init="init()" class="min-h-screen p-4">
        <!-- Header -->
        <header class="mb-8">
            <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl">
                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">SMS Configuration</h1>
                            <p class="text-gray-600">Configure SMS gateway settings for absence alerts</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="principal-dashboard.html" class="px-6 py-2 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-semibold rounded-lg shadow-lg transform transition-all duration-200 hover:scale-[1.02]">
                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                            </svg>
                            Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- SMS Configuration Form -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Configuration Form -->
            <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
                <h2 class="text-xl font-bold text-gray-800 mb-6">SMS Gateway Settings</h2>
                
                <form @submit.prevent="saveConfiguration" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">SMS Provider</label>
                        <select x-model="config.provider" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="twilio">Twilio</option>
                            <option value="nexmo">Nexmo (Vonage)</option>
                            <option value="custom">Custom API</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Account SID</label>
                        <input type="text" x-model="config.accountSid" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Your Account SID">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">API Key / Auth Token</label>
                        <input type="password" x-model="config.apiKey" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Your API Key">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">From Phone Number</label>
                        <input type="tel" x-model="config.fromNumber" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="+1234567890">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">API URL (for custom providers)</label>
                        <input type="url" x-model="config.apiUrl" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="https://api.example.com">
                    </div>

                    <div class="flex items-center">
                        <input type="checkbox" x-model="config.enabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label class="ml-2 text-sm text-gray-700">Enable SMS notifications</label>
                    </div>

                    <div class="flex space-x-4">
                        <button type="submit" :disabled="isLoading" class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold rounded-lg shadow-lg transform transition-all duration-200 hover:scale-[1.02] disabled:opacity-50">
                            <span x-show="!isLoading">Save Configuration</span>
                            <span x-show="isLoading">Saving...</span>
                        </button>
                        <button type="button" @click="testConfiguration" :disabled="isLoading" class="px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold rounded-lg shadow-lg transform transition-all duration-200 hover:scale-[1.02] disabled:opacity-50">
                            Test SMS
                        </button>
                    </div>
                </form>
            </div>

            <!-- SMS Statistics -->
            <div class="space-y-6">
                <!-- Statistics Card -->
                <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">SMS Statistics</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Total SMS Sent</span>
                            <span class="font-semibold text-gray-800" x-text="statistics.totalSMS">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Sent Today</span>
                            <span class="font-semibold text-green-600" x-text="statistics.sentToday">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Failed Today</span>
                            <span class="font-semibold text-red-600" x-text="statistics.failedToday">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Success Rate</span>
                            <span class="font-semibold text-blue-600" x-text="statistics.successRate + '%'">0%</span>
                        </div>
                    </div>
                </div>

                <!-- Test SMS -->
                <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Test SMS</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Test Phone Number</label>
                            <input type="tel" x-model="testPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="+1234567890">
                        </div>
                        <button @click="sendTestSMS" :disabled="!testPhone || isLoading" class="w-full px-4 py-2 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-semibold rounded-lg shadow-lg transform transition-all duration-200 hover:scale-[1.02] disabled:opacity-50">
                            Send Test SMS
                        </button>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Recent SMS Activity</h3>
                    <div class="space-y-3 max-h-64 overflow-y-auto">
                        <template x-for="activity in recentActivity" :key="activity.timestamp">
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-sm font-medium text-gray-800" x-text="activity.studentName"></p>
                                        <p class="text-xs text-gray-600" x-text="activity.type"></p>
                                    </div>
                                    <span class="text-xs px-2 py-1 rounded-full" 
                                          :class="activity.status === 'sent' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                          x-text="activity.status"></span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1" x-text="formatDate(activity.timestamp)"></p>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function smsConfigApp() {
            return {
                config: {
                    provider: 'twilio',
                    accountSid: '',
                    apiKey: '',
                    fromNumber: '',
                    apiUrl: 'https://api.twilio.com/2010-04-01/Accounts',
                    enabled: false
                },
                testPhone: '',
                isLoading: false,
                statistics: {
                    totalSMS: 0,
                    sentToday: 0,
                    failedToday: 0,
                    successRate: 0
                },
                recentActivity: [],

                async init() {
                    this.loadConfiguration();
                    this.loadStatistics();
                    this.loadRecentActivity();
                },

                loadConfiguration() {
                    const saved = localStorage.getItem('sms_configuration');
                    if (saved) {
                        this.config = { ...this.config, ...JSON.parse(saved) };
                    }
                },

                async saveConfiguration() {
                    this.isLoading = true;
                    
                    try {
                        // Save configuration
                        localStorage.setItem('sms_configuration', JSON.stringify(this.config));
                        
                        // Update global SMS service configuration
                        if (window.SMSService) {
                            window.SMS_API_KEY = this.config.apiKey;
                            window.SMS_ACCOUNT_SID = this.config.accountSid;
                            window.SMS_FROM_NUMBER = this.config.fromNumber;
                            window.SMS_API_URL = this.config.apiUrl;
                        }

                        alert('SMS configuration saved successfully!');
                        this.loadStatistics();
                    } catch (error) {
                        alert('Error saving configuration: ' + error.message);
                    } finally {
                        this.isLoading = false;
                    }
                },

                async testConfiguration() {
                    if (!this.testPhone) {
                        alert('Please enter a test phone number');
                        return;
                    }

                    this.isLoading = true;
                    
                    try {
                        if (!window.SMSService) {
                            alert('SMS Service not available');
                            return;
                        }

                        const result = await window.SMSService.testSMSConfiguration(this.testPhone);
                        
                        if (result.success) {
                            alert('Test SMS sent successfully!');
                        } else {
                            alert('Test SMS failed: ' + result.error);
                        }
                    } catch (error) {
                        alert('Error testing SMS: ' + error.message);
                    } finally {
                        this.isLoading = false;
                    }
                },

                async sendTestSMS() {
                    if (!this.testPhone) {
                        alert('Please enter a test phone number');
                        return;
                    }

                    this.isLoading = true;
                    
                    try {
                        if (!window.SMSService) {
                            alert('SMS Service not available');
                            return;
                        }

                        const result = await window.SMSService.testSMSConfiguration(this.testPhone);
                        
                        if (result.success) {
                            alert('Test SMS sent successfully!');
                            this.loadStatistics();
                            this.loadRecentActivity();
                        } else {
                            alert('Test SMS failed: ' + result.error);
                        }
                    } catch (error) {
                        alert('Error sending test SMS: ' + error.message);
                    } finally {
                        this.isLoading = false;
                    }
                },

                loadStatistics() {
                    if (window.SMSService) {
                        this.statistics = window.SMSService.getSMSStatistics();
                    }
                },

                loadRecentActivity() {
                    if (window.SMSService) {
                        this.recentActivity = window.SMSService.getSMSActivityLog(null, 10);
                    }
                },

                formatDate(timestamp) {
                    return new Date(timestamp).toLocaleString();
                }
            }
        }
    </script>
</body>
</html>

