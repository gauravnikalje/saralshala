<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Attendance Upload - School Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .animated-gradient {
            background: linear-gradient(-45deg, #667eea, #764ba2, #f093fb, #f5576c);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        .drag-over { border-color: #3b82f6; background-color: #eff6ff; }
    </style>
</head>
<body class="min-h-screen animated-gradient">
    <div x-data="bulkAttendanceApp()" x-init="init()" class="min-h-screen p-4">
        <header class="mb-8">
            <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl">
                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">Bulk Attendance Upload</h1>
                            <p class="text-gray-600">Bulk attendance management for 1200+ students</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button @click="downloadTemplate()" class="px-6 py-2 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold rounded-lg shadow-lg">
                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            Download Template
                        </button>
                        <a href="dashboard.html" class="px-6 py-2 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-semibold rounded-lg shadow-lg">
                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                            </svg>
                            Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Statistics Cards -->
        <div class="mb-6">
            <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Total Records</p>
                                <p class="text-xl font-bold text-gray-800" x-text="attendanceRecords.length"></p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Valid Records</p>
                                <p class="text-xl font-bold text-gray-800" x-text="getValidRecordsCount()"></p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-red-500 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Error Records</p>
                                <p class="text-xl font-bold text-gray-800" x-text="getErrorRecordsCount()"></p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-orange-500 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Last Upload</p>
                                <p class="text-lg font-bold text-gray-800" x-text="getLastUploadDate()"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Upload Section -->
        <div class="mb-6">
            <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Upload Attendance CSV</h3>
                
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-4"
                     @dragover.prevent="dragOver = true"
                     @dragleave.prevent="dragOver = false"
                     @drop.prevent="handleFileDrop($event)"
                     :class="dragOver ? 'drag-over' : ''">
                    <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <div class="text-lg font-medium text-gray-900 mb-2">Select CSV File</div>
                    <div class="text-sm text-gray-500 mb-4">Drag and drop your attendance CSV file here, or click to browse</div>
                    <input type="file" accept=".csv" @change="handleFileSelect($event)" class="hidden" x-ref="fileInput">
                    <button @click="$refs.fileInput.click()" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium">
                        Choose File
                    </button>
                </div>

                <div x-show="selectedFile" class="bg-gray-50 rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <div>
                                <div class="font-medium text-gray-900" x-text="selectedFile?.name"></div>
                                <div class="text-sm text-gray-500" x-text="formatFileSize(selectedFile?.size)"></div>
                            </div>
                        </div>
                        <button @click="processCSV()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium">
                            Preview Data
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preview Section -->
        <div x-show="previewData.length > 0" class="mb-6">
            <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800">
                        Preview: <span x-text="previewData.length"></span> records
                    </h3>
                    <div class="flex space-x-4">
                        <button @click="confirmBulkUpload()" class="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium">
                            Confirm Upload
                        </button>
                        <button @click="cancelUpload()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-medium">
                            Cancel
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Class</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Date</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Period</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Roll Number</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Student Name</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Status</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Validation</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <template x-for="(record, index) in previewData.slice(0, 20)" :key="index">
                                <tr class="hover:bg-gray-50" :class="record.isValid ? '' : 'bg-red-50'">
                                    <td class="px-4 py-2 text-sm text-gray-900" x-text="record.class"></td>
                                    <td class="px-4 py-2 text-sm text-gray-900" x-text="record.date"></td>
                                    <td class="px-4 py-2 text-sm text-gray-900" x-text="record.period"></td>
                                    <td class="px-4 py-2 text-sm text-gray-900" x-text="record.rollNumber"></td>
                                    <td class="px-4 py-2 text-sm text-gray-900" x-text="record.studentName"></td>
                                    <td class="px-4 py-2 text-sm">
                                        <span :class="getStatusColor(record.status)" class="px-2 py-1 rounded text-xs font-medium" x-text="record.status"></span>
                                    </td>
                                    <td class="px-4 py-2 text-sm">
                                        <span :class="record.isValid ? 'text-green-600' : 'text-red-600'" x-text="record.isValid ? '✓ Valid' : '✗ ' + record.error"></span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="previewData.length > 20" class="text-center py-4 text-gray-500">
                        And <span x-text="previewData.length - 20"></span> more records...
                    </div>
                </div>
            </div>
        </div>

        <!-- Success Message -->
        <div x-show="showSuccessMessage" class="mb-6">
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 fade-in">
                <div class="flex">
                    <svg class="w-5 h-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-green-800">Attendance data uploaded successfully!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function bulkAttendanceApp() {
            return {
                selectedFile: null,
                dragOver: false,
                previewData: [],
                attendanceRecords: [],
                showSuccessMessage: false,
                allStudents: [],
                validStatuses: ['present', 'absent', 'late'],
                
                init() {
                    this.loadStoredData();
                    this.loadStudentData();
                },
                
                loadStoredData() {
                    const stored = localStorage.getItem('bulkAttendanceData');
                    if (stored) {
                        this.attendanceRecords = JSON.parse(stored);
                    }
                },
                
                loadStudentData() {
                    const stored = localStorage.getItem('allStudentsData');
                    if (stored) {
                        this.allStudents = JSON.parse(stored);
                    }
                },
                
                downloadTemplate() {
                    const headers = ['class', 'date', 'period', 'rollNumber', 'studentName', 'status'];
                    const sampleData = [
                        ['10A', '2024-01-15', '1', '001', 'Aarav Sharma', 'present'],
                        ['10A', '2024-01-15', '1', '002', 'Priya Patel', 'absent'],
                        ['10B', '2024-01-15', '2', '003', 'Ravi Kumar', 'late'],
                        ['9A', '2024-01-15', '3', '004', 'Neha Singh', 'present']
                    ];
                    
                    const csvContent = [headers, ...sampleData]
                        .map(row => row.map(field => `"${field}"`).join(','))
                        .join('\\n');
                    
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'attendance_template.csv';
                    a.click();
                    URL.revokeObjectURL(url);
                },
                
                handleFileDrop(event) {
                    this.dragOver = false;
                    const files = event.dataTransfer.files;
                    if (files.length > 0) {
                        this.selectedFile = files[0];
                    }
                },
                
                handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.selectedFile = file;
                    }
                },
                
                formatFileSize(bytes) {
                    if (!bytes) return '';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },
                
                processCSV() {
                    if (!this.selectedFile) return;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const csv = e.target.result;
                        const lines = csv.split('\\n').filter(line => line.trim());
                        
                        this.previewData = lines.slice(1).map((line, index) => {
                            const values = line.split(',').map(v => v.replace(/"/g, '').trim());
                            const record = {
                                class: values[0] || '',
                                date: values[1] || '',
                                period: values[2] || '',
                                rollNumber: values[3] || '',
                                studentName: values[4] || '',
                                status: values[5]?.toLowerCase() || '',
                                rowIndex: index + 2,
                                isValid: true,
                                error: ''
                            };
                            
                            this.validateRecord(record);
                            return record;
                        });
                    };
                    reader.readAsText(this.selectedFile);
                },
                
                validateRecord(record) {
                    if (!record.class || !record.date || !record.period || !record.rollNumber || !record.status) {
                        record.isValid = false;
                        record.error = 'Missing required fields';
                        return;
                    }
                    
                    if (!this.validStatuses.includes(record.status)) {
                        record.isValid = false;
                        record.error = 'Invalid status (use: present, absent, late)';
                        return;
                    }
                    
                    if (!/^\\d{4}-\\d{2}-\\d{2}$/.test(record.date)) {
                        record.isValid = false;
                        record.error = 'Invalid date format (use YYYY-MM-DD)';
                        return;
                    }
                    
                    if (!/^[1-6]$/.test(record.period)) {
                        record.isValid = false;
                        record.error = 'Invalid period (use 1-6)';
                        return;
                    }
                    
                    const studentExists = this.allStudents.some(student => 
                        student.rollNumber === record.rollNumber && 
                        student.class === record.class
                    );
                    
                    if (!studentExists) {
                        record.isValid = false;
                        record.error = 'Student not found in database';
                        return;
                    }
                    
                    record.isValid = true;
                    record.error = '';
                },
                
                confirmBulkUpload() {
                    const validRecords = this.previewData.filter(record => record.isValid);
                    
                    validRecords.forEach(record => {
                        const attendanceKey = `${record.class}_${record.date}_${record.period}`;
                        
                        let existingRecord = this.attendanceRecords.find(ar => ar.id === attendanceKey);
                        
                        if (!existingRecord) {
                            existingRecord = {
                                id: attendanceKey,
                                class: record.class,
                                date: record.date,
                                period: record.period,
                                attendance: {},
                                uploadedAt: new Date().toISOString()
                            };
                            this.attendanceRecords.push(existingRecord);
                        }
                        
                        existingRecord.attendance[record.rollNumber] = {
                            status: record.status,
                            studentName: record.studentName,
                            updatedAt: new Date().toISOString()
                        };
                    });
                    
                    localStorage.setItem('bulkAttendanceData', JSON.stringify(this.attendanceRecords));
                    this.updateRegularAttendanceFormat(validRecords);
                    
                    this.showSuccessMessage = true;
                    setTimeout(() => this.showSuccessMessage = false, 5000);
                    this.resetUpload();
                },
                
                updateRegularAttendanceFormat(validRecords) {
                    validRecords.forEach(record => {
                        const key = `attendance_${record.class}_${record.date}_${record.period}`;
                        let storedAttendance = JSON.parse(localStorage.getItem(key) || '{}');
                        storedAttendance[record.rollNumber] = record.status;
                        localStorage.setItem(key, JSON.stringify(storedAttendance));
                    });
                },
                
                resetUpload() {
                    this.selectedFile = null;
                    this.previewData = [];
                    this.$refs.fileInput.value = '';
                },
                
                cancelUpload() {
                    this.resetUpload();
                },
                
                getValidRecordsCount() {
                    return this.previewData.filter(record => record.isValid).length;
                },
                
                getErrorRecordsCount() {
                    return this.previewData.filter(record => !record.isValid).length;
                },
                
                getLastUploadDate() {
                    if (this.attendanceRecords.length === 0) return 'Never';
                    
                    const latest = this.attendanceRecords.reduce((latest, record) => {
                        return new Date(record.uploadedAt) > new Date(latest.uploadedAt) ? record : latest;
                    });
                    
                    return new Date(latest.uploadedAt).toLocaleDateString();
                },
                
                getStatusColor(status) {
                    switch(status?.toLowerCase()) {
                        case 'present': return 'bg-green-100 text-green-800';
                        case 'absent': return 'bg-red-100 text-red-800';
                        case 'late': return 'bg-yellow-100 text-yellow-800';
                        default: return 'bg-gray-100 text-gray-800';
                    }
                }
            }
        }
    </script>
</body>
</html>