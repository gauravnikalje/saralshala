<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery Manager - SaralShala</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        [x-cloak] { display: none; }
        
        .drag-over {
            @apply border-purple-500 bg-purple-50;
        }
        
        .image-card {
            @apply relative overflow-hidden rounded-lg shadow-md hover:shadow-lg transition-all duration-300;
        }
        
        .image-overlay {
            @apply absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-60 transition-all duration-300 flex items-center justify-center opacity-0 hover:opacity-100;
        }
        
        .crop-container {
            @apply bg-gray-100 p-4 rounded-lg;
        }
        
        .slider-input::-webkit-slider-thumb {
            @apply appearance-none w-6 h-6 rounded-full bg-purple-600 cursor-pointer;
        }
        
        .slider-input::-moz-range-thumb {
            @apply w-6 h-6 rounded-full bg-purple-600 cursor-pointer border-0;
        }
        
        .filter-badge {
            @apply inline-block px-3 py-1 rounded-full text-sm font-semibold;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .animate-spin-slow {
            animation: spin 2s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800" x-data="galleryManager()" x-init="init()" x-cloak>
    <!-- Header Navigation -->
    <header class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <a href="/dashboard.html" class="text-gray-600 hover:text-gray-800 mr-4">
                    <i class="fas fa-arrow-left text-2xl"></i>
                </a>
                <h1 class="text-3xl font-bold text-purple-700">Gallery Manager</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-600">
                    <i class="fas fa-user text-purple-600 mr-2"></i>
                    <span x-text="currentUserName"></span>
                </span>
                <button @click="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        <!-- Category Tabs -->
        <div class="flex gap-2 mb-8 overflow-x-auto pb-2">
            <template x-for="category in categories" :key="category.id">
                <button 
                    @click="selectCategory(category)"
                    :class="selectedCategory.id === category.id ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'"
                    class="px-6 py-2 rounded-lg font-semibold transition-colors whitespace-nowrap">
                    <span x-text="category.display_name"></span>
                    <span class="ml-2 bg-opacity-30 px-2 py-1 rounded" :class="selectedCategory.id === category.id ? 'bg-white' : 'bg-gray-400'" x-text="`(${getCategoryImageCount(category.id)})`"></span>
                </button>
            </template>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Panel: Upload & Controls -->
            <div class="lg:col-span-1">
                <!-- Upload Area -->
                <div 
                    @drop.prevent="handleDrop"
                    @dragover.prevent="isDragging = true"
                    @dragleave.prevent="isDragging = false"
                    :class="isDragging ? 'drag-over' : 'bg-white border-2 border-dashed border-gray-300'"
                    class="p-8 rounded-lg text-center cursor-pointer transition-all duration-300">
                    <input type="file" id="imageInput" @change="handleFileSelect" multiple accept="image/*" class="hidden">
                    
                    <div @click="document.getElementById('imageInput').click()">
                        <i class="fas fa-cloud-upload-alt text-5xl text-purple-400 mb-4"></i>
                        <p class="text-lg font-semibold text-gray-700 mb-2">Upload Images</p>
                        <p class="text-sm text-gray-500 mb-2">Click to upload or drag and drop</p>
                        <p class="text-xs text-gray-400">PNG, JPG, WebP up to 10MB</p>
                    </div>
                </div>

                <!-- Upload Progress -->
                <template x-if="uploadProgress > 0">
                    <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-semibold text-blue-700">Uploading...</span>
                            <span class="text-sm text-blue-600" x-text="`${uploadProgress}%`"></span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full transition-all" :style="`width: ${uploadProgress}%`"></div>
                        </div>
                    </div>
                </template>

                <!-- Upload Status Messages -->
                <template x-if="statusMessage">
                    <div :class="statusType === 'success' ? 'bg-green-50 border-green-200 text-green-700' : 'bg-red-50 border-red-200 text-red-700'"
                         class="mt-4 p-4 border rounded-lg text-sm">
                        <i :class="statusType === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'" class="mr-2"></i>
                        <span x-text="statusMessage"></span>
                    </div>
                </template>

                <!-- Image Info Card -->
                <template x-if="selectedImage">
                    <div class="mt-6 p-4 bg-purple-50 border-2 border-purple-200 rounded-lg">
                        <h3 class="font-bold text-purple-700 mb-3">Selected Image Info</h3>
                        <div class="space-y-2 text-sm">
                            <p><strong>Name:</strong> <span x-text="selectedImage.original_filename"></span></p>
                            <p><strong>Size:</strong> <span x-text="`${(selectedImage.file_size / 1024).toFixed(2)} KB`"></span></p>
                            <p><strong>Dimensions:</strong> <span x-text="`${selectedImage.width} Ã— ${selectedImage.height}px`"></span></p>
                            <p><strong>Uploaded:</strong> <span x-text="new Date(selectedImage.created_at).toLocaleDateString()"></span></p>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Right Panel: Gallery Display & Edit -->
            <div class="lg:col-span-2">
                <!-- Save Order Button -->
                <template x-if="!editingImage && galleryImages.length > 0 && orderChanged">
                    <div class="mb-4 text-right">
                        <button @click="saveOrder()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold transition-colors">
                            <i class="fas fa-save mr-2"></i>Save Order
                        </button>
                    </div>
                </template>

                <!-- Editing Mode -->
                <template x-if="editingImage">
                    <div class="bg-white p-6 rounded-lg shadow-lg border-2 border-purple-300">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-purple-700">Edit Image</h2>
                            <button @click="cancelEdit()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>

                        <!-- Image Preview -->
                        <div class="mb-6">
                            <div class="crop-container mb-4">
                                <img id="editPreview" :src="editingImage.image_url" style="max-width: 100%; max-height: 400px;">
                            </div>
                        </div>

                        <!-- Edit Tabs -->
                        <div class="flex gap-2 mb-4 border-b border-gray-200">
                            <button @click="editMode = 'crop'" :class="editMode === 'crop' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-600'"
                                    class="pb-2 font-semibold transition-colors">
                                <i class="fas fa-crop-alt mr-2"></i>Crop
                            </button>
                            <button @click="editMode = 'resize'" :class="editMode === 'resize' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-600'"
                                    class="pb-2 font-semibold transition-colors">
                                <i class="fas fa-expand mr-2"></i>Resize
                            </button>
                            <button @click="editMode = 'adjust'" :class="editMode === 'adjust' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-600'"
                                    class="pb-2 font-semibold transition-colors">
                                <i class="fas fa-sliders-h mr-2"></i>Adjust
                            </button>
                            <button @click="editMode = 'rotate'" :class="editMode === 'rotate' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-600'"
                                    class="pb-2 font-semibold transition-colors">
                                <i class="fas fa-redo mr-2"></i>Rotate
                            </button>
                            <button @click="editMode = 'info'" :class="editMode === 'info' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-600'"
                                    class="pb-2 font-semibold transition-colors">
                                <i class="fas fa-info-circle mr-2"></i>Info
                            </button>
                        </div>

                        <!-- Crop Mode -->
                        <template x-if="editMode === 'crop'">
                            <div class="space-y-4">
                                <p class="text-sm text-gray-600">
                                    <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                                    Use your mouse to select the area you want to keep
                                </p>
                                <button @click="initCropper()" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition">
                                    <i class="fas fa-edit mr-2"></i>Start Cropping
                                </button>
                            </div>
                        </template>

                        <!-- Resize Mode -->
                        <template x-if="editMode === 'resize'">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        Width (pixels)
                                    </label>
                                    <input type="number" x-model.number="imageEdit.width" min="100" max="2000" 
                                           @input="updatePreview()"
                                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        <input type="checkbox" x-model="imageEdit.maintainAspect" class="mr-2" @input="updatePreview()">
                                        Maintain Aspect Ratio
                                    </label>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Height (pixels)</label>
                                    <input type="number" x-model.number="imageEdit.height" min="100" max="2000" 
                                           @input="updatePreview()"
                                           :disabled="imageEdit.maintainAspect"
                                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 disabled:bg-gray-100">
                                </div>
                                <div class="text-sm text-gray-600 bg-gray-50 p-3 rounded">
                                    Current: <span x-text="`${editingImage.width} Ã— ${editingImage.height}px`"></span>
                                </div>
                            </div>
                        </template>

                        <!-- Adjust Mode (Brightness, Contrast, etc.) -->
                        <template x-if="editMode === 'adjust'">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        Brightness
                                        <span class="float-right text-gray-500" x-text="`${imageEdit.brightness}%`"></span>
                                    </label>
                                    <input type="range" x-model.number="imageEdit.brightness" min="0" max="200" step="5"
                                           @input="updatePreview()"
                                           class="slider-input w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        Contrast
                                        <span class="float-right text-gray-500" x-text="`${imageEdit.contrast}%`"></span>
                                    </label>
                                    <input type="range" x-model.number="imageEdit.contrast" min="0" max="200" step="5"
                                           @input="updatePreview()"
                                           class="slider-input w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        Saturation
                                        <span class="float-right text-gray-500" x-text="`${imageEdit.saturation}%`"></span>
                                    </label>
                                    <input type="range" x-model.number="imageEdit.saturation" min="0" max="200" step="5"
                                           @input="updatePreview()"
                                           class="slider-input w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        Hue
                                        <span class="float-right text-gray-500" x-text="`${imageEdit.hue}Â°`"></span>
                                    </label>
                                    <input type="range" x-model.number="imageEdit.hue" min="0" max="360" step="5"
                                           @input="updatePreview()"
                                           class="slider-input w-full">
                                </div>
                                <button @click="resetAdjustments()" class="w-full bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition">
                                    <i class="fas fa-redo mr-2"></i>Reset Adjustments
                                </button>
                            </div>
                        </template>

                        <!-- Rotate Mode -->
                        <template x-if="editMode === 'rotate'">
                            <div class="space-y-4">
                                <div class="flex gap-2">
                                    <button @click="rotateImage(90)" class="flex-1 bg-gray-200 py-2 rounded-lg hover:bg-gray-300 transition">
                                        <i class="fas fa-redo-alt mr-2"></i>90Â° CW
                                    </button>
                                    <button @click="rotateImage(-90)" class="flex-1 bg-gray-200 py-2 rounded-lg hover:bg-gray-300 transition">
                                        <i class="fas fa-undo-alt mr-2"></i>90Â° CCW
                                    </button>
                                </div>
                                <div class="flex gap-2">
                                    <button @click="flipImage('horizontal')" class="flex-1 bg-gray-200 py-2 rounded-lg hover:bg-gray-300 transition">
                                        <i class="fas fa-exchange-alt mr-2"></i>Flip H
                                    </button>
                                    <button @click="flipImage('vertical')" class="flex-1 bg-gray-200 py-2 rounded-lg hover:bg-gray-300 transition">
                                        <i class="fas fa-arrows-alt-v mr-2"></i>Flip V
                                    </button>
                                </div>
                            </div>
                        </template>

                        <!-- Info Mode -->
                        <template x-if="editMode === 'info'">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Title</label>
                                    <input type="text" x-model="imageEdit.title" placeholder="Image title..."
                                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                                    <textarea x-model="imageEdit.description" placeholder="Image description..."
                                              rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Alt Text (for accessibility)</label>
                                    <input type="text" x-model="imageEdit.alt_text" placeholder="Describe the image for screen readers..."
                                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                            </div>
                        </template>

                        <!-- Action Buttons -->
                        <div class="mt-6 flex gap-3">
                            <button @click="saveChanges()" class="flex-1 bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition font-semibold">
                                <i class="fas fa-save mr-2"></i>Save Changes
                            </button>
                            <button @click="cancelEdit()" class="flex-1 bg-gray-400 text-white py-2 rounded-lg hover:bg-gray-500 transition font-semibold">
                                <i class="fas fa-times mr-2"></i>Cancel
                            </button>
                        </div>
                    </div>
                </template>

                <!-- Gallery Grid View -->
                <template x-if="!editingImage && galleryImages.length > 0">
                    <div id="galleryGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <template x-for="image in galleryImages" :key="image.id">
                            <div class="image-card group" :data-id="image.id">
                                <div class="relative aspect-video overflow-hidden bg-gray-100 rounded-lg">
                                    <div class="absolute top-2 left-2 z-10 bg-gray-800 bg-opacity-50 text-white text-xs font-bold px-2 py-1 rounded">
                                        Pos: <span x-text="image.position"></span>
                                    </div>
                                    <img :src="image.image_url" :alt="image.alt_text || 'Gallery image'" 
                                         class="w-full h-full object-cover">
                                    
                                    <div class="image-overlay">
                                        <div class="flex gap-2">
                                            <button @click="editImage(image)" 
                                                    class="bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-full transition"
                                                    title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button @click="deleteImage(image)" 
                                                    class="bg-red-500 hover:bg-red-600 text-white p-3 rounded-full transition"
                                                    title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="p-3">
                                    <p class="text-sm font-semibold text-gray-700 truncate" x-text="image.title || image.original_filename"></p>
                                    <p class="text-xs text-gray-500 mt-1" x-text="`${(image.file_size / 1024).toFixed(1)}KB â€¢ ${image.width}Ã—${image.height}px`"></p>
                                    <p class="text-xs text-gray-400 mt-1" x-text="new Date(image.created_at).toLocaleDateString()"></p>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>

                <!-- Empty State -->
                <template x-if="!editingImage && galleryImages.length === 0">
                    <div class="text-center py-16 bg-white rounded-lg border-2 border-dashed border-gray-300">
                        <i class="fas fa-image text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg font-semibold mb-2">No images in this category yet</p>
                        <p class="text-gray-400 text-sm">Upload some images to get started!</p>
                    </div>
                </template>
            </div>
        </div>
    </main>

    <!-- Delete Confirmation Modal -->
    <template x-if="showDeleteConfirm">
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>Confirm Delete
                </h3>
                <p class="text-gray-600 mb-6">Are you sure you want to delete this image? This action cannot be undone.</p>
                <div class="flex gap-3">
                    <button @click="confirmDelete()" class="flex-1 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition font-semibold">
                        <i class="fas fa-trash mr-2"></i>Delete
                    </button>
                    <button @click="showDeleteConfirm = false; deleteImageToConfirm = null" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition font-semibold">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </template>

    <script type="module">
        // Import Supabase
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        const supabaseUrl = 'https://gxpydymawnoascdapznu.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4cHlkeW1hd25vYXNjZGFwem51Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NTkwMTIsImV4cCI6MjA3NDAzNTAxMn0.DQfgDDipMexRCgJkEjUlEcb5MZNvTmbGYYn5BoTju3w';
        const supabase = createClient(supabaseUrl, supabaseAnonKey);

        window.galleryManager = function() {
            return {
                categories: [],
                selectedCategory: {},
                galleryImages: [],
                currentUser: null,
                currentUserName: 'Loading...',
                isDragging: false,
                uploadProgress: 0,
                statusMessage: '',
                statusType: '',
                selectedImage: null,
                editingImage: null,
                editMode: 'crop',
                cropper: null,
                showDeleteConfirm: false,
                deleteImageToConfirm: null,
                sortable: null,
                orderChanged: false,
                imageEdit: {
                    width: 0,
                    height: 0,
                    maintainAspect: true,
                    brightness: 100,
                    contrast: 100,
                    saturation: 100,
                    hue: 0,
                    rotation: 0,
                    flipH: false,
                    flipV: false,
                    title: '',
                    description: '',
                    alt_text: ''
                },

                async init() {
                    await this.checkAuth();
                    await this.loadCategories();
                    if (this.categories.length > 0) {
                        this.selectCategory(this.categories[0]);
                    }
                    this.initSortable();
                },

                initSortable() {
                    this.$nextTick(() => {
                        const grid = document.getElementById('galleryGrid');
                        if (grid) {
                            this.sortable = new Sortable(grid, {
                                animation: 150,
                                onEnd: (evt) => this.handleReorder(evt)
                            });
                        }
                    });
                },

                handleReorder(evt) {
                    const movedItem = this.galleryImages.splice(evt.oldIndex, 1)[0];
                    this.galleryImages.splice(evt.newIndex, 0, movedItem);

                    // Update position numbers
                    this.galleryImages.forEach((img, index) => {
                        img.position = index + 1;
                    });
                    this.orderChanged = true;
                },

                async saveOrder() {
                    try {
                        const updates = this.galleryImages.map(img => ({
                            id: img.id,
                            position: img.position
                        }));

                        const { error } = await supabase
                            .from('gallery_images')
                            .upsert(updates);

                        if (error) throw error;

                        this.showStatus('Image order saved successfully!', 'success');
                        this.orderChanged = false;
                        this.loadGalleryImages();
                    } catch(error) {
                        console.error('Save order error:', error);
                        this.showStatus('Failed to save image order', 'error');
                    }
                },

                async checkAuth() {
                    try {
                        const { data: { session }, error } = await supabase.auth.getSession();
                        if (error || !session) {
                            window.location.href = '/login.html';
                            return;
                        }
                        this.currentUser = session.user;
                        const { data: teacher } = await supabase
                            .from('teachers')
                            .select('name, role')
                            .eq('id', this.currentUser.id)
                            .single();
                        if (teacher) {
                            this.currentUserName = teacher.name;
                        }
                    } catch (error) {
                        console.error('Auth check failed:', error);
                        window.location.href = '/login.html';
                    }
                },

                async loadCategories() {
                    try {
                        const { data, error } = await supabase
                            .from('gallery_categories')
                            .select('*')
                            .order('display_order', { ascending: true });
                        if (error) throw error;
                        this.categories = data;
                    } catch (error) {
                        console.error('Load categories error:', error);
                        this.showStatus('Failed to load categories', 'error');
                    }
                },

                selectCategory(category) {
                    this.selectedCategory = category;
                    this.orderChanged = false; // Reset on category change
                    this.loadGalleryImages();
                },

                async loadGalleryImages() {
                    try {
                        const { data, error } = await supabase
                            .from('gallery_images')
                            .select('*')
                            .eq('category_id', this.selectedCategory.id)
                            .eq('is_active', true)
                            .order('position', { ascending: true });
                        if (error) throw error;
                        this.galleryImages = data || [];
                    } catch (error) {
                        console.error('Load gallery error:', error);
                        this.showStatus('Failed to load images', 'error');
                    }
                },

                getCategoryImageCount(categoryId) {
                    return this.galleryImages.filter(img => img.category_id === categoryId).length;
                },

                handleFileSelect(event) {
                    const files = Array.from(event.target.files);
                    this.uploadImages(files);
                },

                handleDrop(event) {
                    this.isDragging = false;
                    const files = Array.from(event.dataTransfer.files).filter(file => file.type.startsWith('image/'));
                    this.uploadImages(files);
                },

                async uploadImages(files) {
                    if (files.length === 0) return;
                    
                    for (const file of files) {
                        if (file.size > 10 * 1024 * 1024) {
                            this.showStatus(`File ${file.name} is too large (max 10MB)`, 'error');
                            continue;
                        }

                        try {
                            this.uploadProgress = 0;

                            // Get image dimensions
                            const dimensions = await this.getImageDimensions(file);

                            // Upload to storage
                            const fileExt = file.name.split('.').pop();
                            const fileName = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
                            const filePath = `gallery/${this.selectedCategory.name}/${fileName}`;

                            const { data: uploadData, error: uploadError } = await supabase.storage
                                .from('gallery-images')
                                .upload(filePath, file);

                            if (uploadError) throw uploadError;

                            // Get public URL
                            const { data } = supabase.storage
                                .from('gallery-images')
                                .getPublicUrl(filePath);

                            // Save to database
                            const { error: dbError } = await supabase
                                .from('gallery_images')
                                .insert([{
                                    category_id: this.selectedCategory.id,
                                    uploader_id: this.currentUser.id,
                                    image_url: data.publicUrl,
                                    image_path: filePath,
                                    original_filename: file.name,
                                    file_size: file.size,
                                    width: dimensions.width,
                                    height: dimensions.height,
                                    format: fileExt.toLowerCase(),
                                    alt_text: '',
                                    position: this.galleryImages.length + 1
                                }]);

                            if (dbError) throw dbError;

                            this.uploadProgress = 100;
                            this.showStatus(`Image uploaded successfully!`, 'success');
                            
                            setTimeout(() => {
                                this.uploadProgress = 0;
                                this.loadGalleryImages();
                            }, 1000);

                        } catch (error) {
                            console.error('Upload error:', error);
                            this.showStatus(`Failed to upload ${file.name}`, 'error');
                            this.uploadProgress = 0;
                        }
                    }
                },

                getImageDimensions(file) {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = new Image();
                            img.onload = () => {
                                resolve({ width: img.width, height: img.height });
                            };
                            img.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    });
                },

                editImage(image) {
                    this.editingImage = { ...image };
                    this.imageEdit = {
                        width: image.width,
                        height: image.height,
                        maintainAspect: true,
                        brightness: 100,
                        contrast: 100,
                        saturation: 100,
                        hue: 0,
                        rotation: 0,
                        title: image.title || '',
                        description: image.description || '',
                        alt_text: image.alt_text || ''
                    };
                    this.editMode = 'info';
                    this.selectedImage = image;
                },

                cancelEdit() {
                    this.editingImage = null;
                    this.editMode = 'crop';
                    if (this.cropper) {
                        this.cropper.destroy();
                        this.cropper = null;
                    }
                },

                initCropper() {
                    const image = document.getElementById('editPreview');
                    if (this.cropper) {
                        this.cropper.destroy();
                    }
                    this.cropper = new Cropper(image, {
                        aspectRatio: NaN,
                        autoCropArea: 1,
                        responsive: true,
                        guides: true,
                        highlight: true,
                        cropBoxMovable: true,
                        cropBoxResizable: true
                    });
                },

                rotateImage(angle) {
                    this.imageEdit.rotation = (this.imageEdit.rotation + angle) % 360;
                },

                flipImage(direction) {
                    if (direction === 'horizontal') {
                        this.imageEdit.flipH = !this.imageEdit.flipH;
                    } else {
                        this.imageEdit.flipV = !this.imageEdit.flipV;
                    }
                },

                resetAdjustments() {
                    this.imageEdit.brightness = 100;
                    this.imageEdit.contrast = 100;
                    this.imageEdit.saturation = 100;
                    this.imageEdit.hue = 0;
                },

                async updatePreview() {
                    // Update the preview image with current edit settings
                    try {
                        const canvas = await this.generateEditedImage();
                        const previewImg = document.getElementById('editPreview');
                        if (previewImg) {
                            previewImg.src = canvas.toDataURL('image/jpeg', 0.9);
                        }
                    } catch (error) {
                        console.error('Error updating preview:', error);
                    }
                },

                deleteImage(image) {
                    this.deleteImageToConfirm = image;
                    this.showDeleteConfirm = true;
                },

                async confirmDelete() {
                    try {
                        const image = this.deleteImageToConfirm;
                        
                        // Delete from storage
                        await supabase.storage
                            .from('gallery-images')
                            .remove([image.image_path]);

                        // Soft delete from database
                        await supabase
                            .from('gallery_images')
                            .update({ is_active: false })
                            .eq('id', image.id);

                        // Log edit history
                        await supabase
                            .from('gallery_edit_history')
                            .insert([{
                                image_id: image.id,
                                editor_id: this.currentUser.id,
                                action: 'delete',
                                changes: { status: 'deleted' }
                            }]);

                        this.showStatus('Image deleted successfully', 'success');
                        this.showDeleteConfirm = false;
                        this.deleteImageToConfirm = null;
                        this.loadGalleryImages();
                    } catch (error) {
                        console.error('Delete error:', error);
                        this.showStatus('Failed to delete image', 'error');
                    }
                },

                async saveChanges() {
                    try {
                        const canvas = await this.generateEditedImage();
                        
                        // Upload edited image
                        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
                        const fileExt = this.editingImage.format || 'jpg';
                        const fileName = `${Date.now()}_edited.${fileExt}`;
                        const filePath = `gallery/${this.selectedCategory.name}/${fileName}`;

                        const { error: uploadError } = await supabase.storage
                            .from('gallery-images')
                            .upload(filePath, blob);

                        if (uploadError) throw uploadError;

                        const { data } = supabase.storage
                            .from('gallery-images')
                            .getPublicUrl(filePath);

                        // Update database
                        const { error: updateError } = await supabase
                            .from('gallery_images')
                            .update({
                                image_url: data.publicUrl,
                                image_path: filePath,
                                width: this.imageEdit.width,
                                height: this.imageEdit.height,
                                title: this.imageEdit.title,
                                description: this.imageEdit.description,
                                alt_text: this.imageEdit.alt_text,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', this.editingImage.id);

                        if (updateError) throw updateError;

                        // Log edit history
                        await supabase
                            .from('gallery_edit_history')
                            .insert([{
                                image_id: this.editingImage.id,
                                editor_id: this.currentUser.id,
                                action: this.editMode,
                                changes: this.imageEdit
                            }]);

                        this.showStatus('Changes saved successfully!', 'success');
                        this.cancelEdit();
                        this.loadGalleryImages();
                    } catch (error) {
                        console.error('Save error:', error);
                        this.showStatus('Failed to save changes', 'error');
                    }
                },

                async generateEditedImage() {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.src = this.editingImage.image_url;

                    return new Promise((resolve) => {
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = this.imageEdit.width;
                            canvas.height = this.imageEdit.height;
                            const ctx = canvas.getContext('2d');

                            // Apply transforms
                            ctx.filter = `brightness(${this.imageEdit.brightness}%) contrast(${this.imageEdit.contrast}%) saturate(${this.imageEdit.saturation}%) hue-rotate(${this.imageEdit.hue}deg)`;
                            
                            ctx.save();
                            ctx.translate(canvas.width / 2, canvas.height / 2);
                            ctx.rotate((this.imageEdit.rotation * Math.PI) / 180);
                            if (this.imageEdit.flipH) ctx.scale(-1, 1);
                            if (this.imageEdit.flipV) ctx.scale(1, -1);
                            ctx.drawImage(img, -canvas.width / 2, -canvas.height / 2, canvas.width, canvas.height);
                            ctx.restore();

                            resolve(canvas);
                        };
                    });
                },

                showStatus(message, type) {
                    this.statusMessage = message;
                    this.statusType = type;
                    setTimeout(() => {
                        this.statusMessage = '';
                    }, 4000);
                },

                async logout() {
                    try {
                        await supabase.auth.signOut();
                        window.location.href = '/login.html';
                    } catch (error) {
                        console.error('Logout error:', error);
                    }
                }
            }
        }
    </script>
</body>
</html>
