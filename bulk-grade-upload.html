<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Grade Upload - School Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        @keyframes gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .animated-gradient { background: linear-gradient(-45deg, #667eea, #764ba2, #f093fb, #f5576c); background-size: 400% 400%; animation: gradient 15s ease infinite; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        .drag-over { border-color: #3b82f6; background-color: #eff6ff; }
    </style>
</head>
<body class="min-h-screen animated-gradient">
    <div x-data="bulkGradeApp()" x-init="init()" class="min-h-screen p-4">
        <header class="mb-8">
            <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl">
                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">Bulk Grade Upload</h1>
                            <p class="text-gray-600">Upload grades for multiple students at once</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button @click="downloadGradeTemplate()" class="px-6 py-2 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold rounded-lg shadow-lg">
                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            Download Template
                        </button>
                        <a href="gradebook.html" class="px-6 py-2 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-semibold rounded-lg shadow-lg">
                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                            </svg>
                            Back to Gradebook
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <div class="mb-6">
            <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Select Assessment</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Class</label>
                        <select x-model="selectedClassId" @change="loadStudentsForClass()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                            <option value="">Select Class</option>
                            <option value="10a-math">Class 10A - Mathematics</option>
                            <option value="10b-math">Class 10B - Mathematics</option>
                            <option value="9a-math">Class 9A - Mathematics</option>
                            <option value="9b-math">Class 9B - Mathematics</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Assessment</label>
                        <select x-model="selectedAssessmentId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                            <option value="">Select Assessment</option>
                            <option value="q1-2024">First Quarter Test (50 marks)</option>
                            <option value="mid-2024">Mid-term Exam (100 marks)</option>
                            <option value="assign-1">Assignment 1 (20 marks)</option>
                            <option value="final-2024">Final Exam (100 marks)</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button @click="generateTemplate()" :disabled="!selectedClassId || !selectedAssessmentId" class="w-full px-4 py-2 bg-emerald-500 hover:bg-emerald-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded-lg font-medium">
                            Generate Template
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="templateGenerated" class="mb-6">
            <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Upload Grade File</h3>
                
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-4"
                     @dragover.prevent="dragOver = true"
                     @dragleave.prevent="dragOver = false"
                     @drop.prevent="handleFileDrop($event)"
                     :class="dragOver ? 'drag-over' : ''">
                    <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    <div class="text-lg font-medium text-gray-900 mb-2">Upload Completed Grade File</div>
                    <div class="text-sm text-gray-500 mb-4">Drag and drop your completed CSV file here, or click to browse</div>
                    <input type="file" accept=".csv" @change="handleFileSelect($event)" class="hidden" x-ref="fileInput">
                    <button @click="$refs.fileInput.click()" class="px-6 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-medium">
                        Choose File
                    </button>
                </div>

                <div x-show="selectedFile" class="bg-gray-50 rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <div>
                                <div class="font-medium text-gray-900" x-text="selectedFile?.name"></div>
                                <div class="text-sm text-gray-500" x-text="formatFileSize(selectedFile?.size)"></div>
                            </div>
                        </div>
                        <button @click="processGradeCSV()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium">
                            Process Grades
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="previewGrades.length > 0" class="mb-6">
            <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800">Preview Grades: <span x-text="previewGrades.length"></span> students</h3>
                    <div class="flex space-x-4">
                        <button @click="confirmGradeUpload()" class="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium">
                            Upload Grades
                        </button>
                        <button @click="cancelGradeUpload()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-medium">
                            Cancel
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Roll Number</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Student Name</th>
                                <th class="px-4 py-2 text-center text-sm font-medium text-gray-700">Marks</th>
                                <th class="px-4 py-2 text-center text-sm font-medium text-gray-700">Percentage</th>
                                <th class="px-4 py-2 text-center text-sm font-medium text-gray-700">Grade</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <template x-for="grade in previewGrades" :key="grade.rollNumber">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-2 text-sm font-medium text-gray-900" x-text="grade.rollNumber"></td>
                                    <td class="px-4 py-2 text-sm text-gray-900" x-text="grade.studentName"></td>
                                    <td class="px-4 py-2 text-sm text-center text-gray-900">
                                        <span x-text="grade.marks"></span>/<span x-text="grade.maxMarks"></span>
                                    </td>
                                    <td class="px-4 py-2 text-sm text-center">
                                        <span :class="getPercentageColor(grade.percentage)" x-text="grade.percentage + '%'"></span>
                                    </td>
                                    <td class="px-4 py-2 text-center">
                                        <span class="px-2 py-1 rounded-full text-xs font-medium" :class="getGradeColor(grade.grade)" x-text="grade.grade"></span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div x-show="studentsForTemplate.length > 0" class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Students in Selected Class</h3>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gradient-to-r from-emerald-500 to-emerald-600 text-white">
                        <tr>
                            <th class="px-6 py-4 text-left text-sm font-medium uppercase">Roll Number</th>
                            <th class="px-6 py-4 text-left text-sm font-medium uppercase">Student Name</th>
                            <th class="px-6 py-4 text-left text-sm font-medium uppercase">Email</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        <template x-for="student in studentsForTemplate.slice(0, 20)" :key="student.id">
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 text-sm font-medium text-gray-900" x-text="student.rollNumber"></td>
                                <td class="px-6 py-4 text-sm text-gray-900" x-text="student.name"></td>
                                <td class="px-6 py-4 text-sm text-gray-900" x-text="student.email"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
                <div x-show="studentsForTemplate.length > 20" class="text-center py-4 text-gray-500">
                    And <span x-text="studentsForTemplate.length - 20"></span> more students...
                </div>
            </div>
        </div>
    </div>

    <script>
        function bulkGradeApp() {
            return {
                user: null, selectedFile: null, previewGrades: [], dragOver: false, 
                selectedClassId: '', selectedAssessmentId: '', templateGenerated: false,
                studentsForTemplate: [],
                assessments: {
                    'q1-2024': { name: 'First Quarter Test', maxMarks: 50 },
                    'mid-2024': { name: 'Mid-term Exam', maxMarks: 100 },
                    'assign-1': { name: 'Assignment 1', maxMarks: 20 },
                    'final-2024': { name: 'Final Exam', maxMarks: 100 }
                },

                async init() {
                    const userStr = sessionStorage.getItem('user');
                    if (userStr) { this.user = JSON.parse(userStr); }
                    if (!this.user || this.user.role !== 'teacher') { window.location.href = '/login.html'; return; }
                },

                loadStudentsForClass() {
                    if (!this.selectedClassId) { this.studentsForTemplate = []; return; }
                    
                    const allStudents = JSON.parse(localStorage.getItem('allStudentsData') || '[]');
                    const classMapping = { '10a-math': '10A', '10b-math': '10B', '9a-math': '9A', '9b-math': '9B' };
                    const targetClass = classMapping[this.selectedClassId];
                    
                    if (targetClass) {
                        this.studentsForTemplate = allStudents.filter(student => student.class === targetClass);
                    }
                },

                generateTemplate() {
                    if (!this.selectedClassId || !this.selectedAssessmentId) return;
                    
                    const assessment = this.assessments[this.selectedAssessmentId];
                    const headers = ['rollNumber', 'studentName', 'marks'];
                    let csv = headers.join(',') + '\n';
                    
                    this.studentsForTemplate.forEach(student => {
                        csv += `"${student.rollNumber}","${student.name}",""\n`;
                    });
                    
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.setAttribute('hidden', ''); a.setAttribute('href', url);
                    a.setAttribute('download', `grade-template-${this.selectedClassId}-${this.selectedAssessmentId}.csv`);
                    document.body.appendChild(a); a.click(); document.body.removeChild(a);
                    
                    this.templateGenerated = true;
                },

                downloadGradeTemplate() {
                    const headers = ['rollNumber', 'studentName', 'marks'];
                    const sample = 'STD001,John Doe,85';
                    const csv = headers.join(',') + '\n' + sample;
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.setAttribute('hidden', ''); a.setAttribute('href', url);
                    a.setAttribute('download', 'grade-template-sample.csv');
                    document.body.appendChild(a); a.click(); document.body.removeChild(a);
                },

                handleFileSelect(event) { this.selectedFile = event.target.files[0]; },

                handleFileDrop(event) {
                    this.dragOver = false;
                    const files = event.dataTransfer.files;
                    if (files.length > 0 && files[0].type === 'text/csv') { this.selectedFile = files[0]; }
                },

                processGradeCSV() {
                    if (!this.selectedFile) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const csv = e.target.result;
                        const lines = csv.split('\n');
                        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                        this.previewGrades = [];
                        
                        const assessment = this.assessments[this.selectedAssessmentId];
                        
                        for (let i = 1; i < lines.length; i++) {
                            if (lines[i].trim()) {
                                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                                const grade = {
                                    rollNumber: values[0],
                                    studentName: values[1],
                                    marks: parseInt(values[2]) || 0,
                                    maxMarks: assessment.maxMarks
                                };
                                
                                grade.percentage = Math.round((grade.marks / grade.maxMarks) * 100);
                                
                                if (grade.percentage >= 90) grade.grade = 'A+';
                                else if (grade.percentage >= 80) grade.grade = 'A';
                                else if (grade.percentage >= 70) grade.grade = 'B+';
                                else if (grade.percentage >= 60) grade.grade = 'B';
                                else if (grade.percentage >= 50) grade.grade = 'C';
                                else if (grade.percentage >= 40) grade.grade = 'D';
                                else grade.grade = 'F';
                                
                                this.previewGrades.push(grade);
                            }
                        }
                    };
                    reader.readAsText(this.selectedFile);
                },

                confirmGradeUpload() {
                    const key = `grades_${this.selectedClassId}_${this.selectedAssessmentId}`;
                    const gradeData = this.previewGrades.map(grade => ({
                        studentId: grade.rollNumber,
                        studentName: grade.studentName,
                        rollNumber: grade.rollNumber,
                        marks: grade.marks,
                        percentage: grade.percentage,
                        grade: grade.grade,
                        timestamp: new Date().toISOString()
                    }));
                    
                    localStorage.setItem(key, JSON.stringify(gradeData));
                    alert(`Successfully uploaded grades for ${this.previewGrades.length} students!`);
                    this.cancelGradeUpload();
                },

                cancelGradeUpload() {
                    this.selectedFile = null; this.previewGrades = [];
                    this.$refs.fileInput.value = '';
                },

                getPercentageColor(percentage) {
                    if (percentage >= 80) return 'text-green-600 font-semibold';
                    else if (percentage >= 60) return 'text-blue-600 font-semibold';
                    else if (percentage >= 40) return 'text-yellow-600 font-semibold';
                    else return 'text-red-600 font-semibold';
                },

                getGradeColor(grade) {
                    if (['A+', 'A'].includes(grade)) return 'bg-green-100 text-green-800';
                    else if (['B+', 'B'].includes(grade)) return 'bg-blue-100 text-blue-800';
                    else if (grade === 'C') return 'bg-yellow-100 text-yellow-800';
                    else if (grade === 'D') return 'bg-orange-100 text-orange-800';
                    else return 'bg-red-100 text-red-800';
                },

                formatFileSize(bytes) {
                    if (!bytes) return '0 Bytes';
                    const k = 1024; const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                }
            }
        }
    </script>
</body>
</html>